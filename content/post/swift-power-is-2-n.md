+++
date = "2016-01-5T09:53:35+08:00"
draft = true
title = "一致性哈希虚拟节点数是2的n次幂的原因"

+++

我们知道Swift使用一致性哈希算法，其中用户需要设置part_power（part表示partition也就是虚拟节点，power表示幂），而虚拟节点数就等同于2的part_power次方。

使用2的n次方对一致性哈希性能有极大的好处，所有数据做完哈希（例如使用md5）后需要映射到虚拟节点，传统的方法是取余，效率比较低，更高效的方法是位移（bit shift）。任何32位的数据，向右位移24位，就得到0～1023（2的8次方）的数，在一致性哈希中这就是1024个虚拟节点。在Swift中，所有对象都是通过md5哈希的，得到一个4 byte也就是32 bit的数，例如用户设置part_power为8，那么代码会计算part_shift是32-8也就是24，每次md5后右移24位，这样通过位移实现了数据的一致性哈希并且找到唯一对应的虚拟节点。
