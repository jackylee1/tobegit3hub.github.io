+++
date = "2016-05-06T11:52:50+08:00"
draft = true
title = "OpenStack AB模块架构设计"

+++

## 问题描述

目前OpenStack集群采用AB模块，一个OpenStack管理两套Ceph，预期是A模块挂了不影响B模块的服务，B模块挂了不影响A模块的服务。经过HA测试验证目前A模块挂了，会整个集群的OpenStack服务，根据现在的多Region方案，在最坏情况下宕掉一个模块会影响黄务业务2网、黄务隔离网和未来的黄务业务1网共6个模块。

具体原因是A模块拥有两个mysql节点，我们部署架构中三个mysql挂了两个会导致整个MySQL服务不可用，进而导致OpenStack服务不可用。目前使用MySQL galera集群为了保证数据强一致性和正确解决分区故障，无法规避这个问题。在任意的集群方案要想划分AB模块，在某个模块只有少数的情况下要同时保证数据强一致性和分区容忍性是不可能的，需要调整方案满足需求。

## 解决方案

为了提高服务可用性，我们技术团队提供以下解决方案。

方案一，提供于AB模块独立的C模块，由机房保证A、B、C三个模块不会同时宕掉并且三者之间不会同时网络分区，通过将控制节点部署到三个模块上保证高可用，经过HA测试宕掉任意一个模块OpenStack能够自动恢复。这要求机房能提供额外的物理和网络环境，能彻底解决控制节点高可用的问题，避免了人工修复、数据不一致等风险。

方案二，在原有MySQL galera三节点基础上多加一个MySQL从节点，用于同步集群数据，作为数据库热备。如果A模块宕掉会影响galera集群，这时通过手工切换可以使用备数据库，从而恢复OpenStack服务。此方案要求在B模块的控制节点多起一台MySQL虚拟机，同步MySQL数据，数据库切换必须安装文档正确执行，在A模块恢复后也需要暂停MySQL服务手动同步数据，这种方案也能保证数据正确性，同时在任意一个模块宕掉都能提供服务。

如果未来考虑从方案二过渡到方案一，只需要迁移一台控制节点到新的C模块只需通过迁移一个控制节点即可，迁移时关机和宕机测试一样，能保证在5分钟内自动恢复服务。

## 影响范围

如果不采用方案一或方案二，这样就没有AB模块的高可用，在宕掉A模块后会影响整个集群或多个集群，但不影响已有虚拟机的业务服务。

如果采用方案一，部署架构上把三个控制节点分配的三个模块上即可，对原有配置和服务不需要任何修改，但需要机房或服务方提供独立的C模块。

如果采用方案二，部署架构没有过多调整，A模块发生故障时需要手动迁数据库，正常处理时间在分钟级别，而且不会影响已有的虚拟机业务，在A模块恢复后需要听写数据库，手动恢复数据到galera集群，此时也不会影响已有的虚拟机业务。






